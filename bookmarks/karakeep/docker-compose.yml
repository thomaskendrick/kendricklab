version: "3.8"

services:
  karakeep:
    image: ghcr.io/karakeep-app/karakeep:latest
    container_name: karakeep
    restart: unless-stopped
    depends_on:
      - meilisearch
      - chrome
    environment:
      - MEILI_ADDR=http://meilisearch:7700
      - BROWSER_WEB_URL=http://chrome:9222
      - DATA_DIR=/data
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - OPENAI_BASE_URL=https://generativelanguage.googleapis.com/v1beta/openai/
      - OPENAI_API_KEY=${GEMINI_API_KEY}
      - INFERENCE_TEXT_MODEL=gemini-2.5-flash
      - INFERENCE_IMAGE_MODEL=gemini-2.5-flash
      - OAUTH_CLIENT_ID=${OAUTH_AUTH_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
      - OAUTH_WELLKNOWN_URL=https://auth.${DOMAIN}/application/o/karakeep/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=authentik
      - OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING=true
      - DISABLE_PASSWORD_AUTH=true
      - DISABLE_SIGNUPS=true
    volumes:
      - ${CONFIG_ROOT}/karakeep/data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"
      - "traefik.http.routers.karakeep.rule=Host(`karakeep.${DOMAIN}`)"
      - "traefik.http.routers.karakeep.entrypoints=https"
      - "traefik.http.routers.karakeep.tls.certresolver=cloudflare"
      - "traefik.http.services.karakeep.loadbalancer.server.port=3000"
      - "homepage.group=Bookmarks"
      - "homepage.name=Karakeep"
      - "homepage.icon=karakeep.png"
      - "homepage.href=https://karakeep.${DOMAIN}"
      - "homepage.description=AI Bookmarking Tool"
    networks:
      - traefik_public
      - internal

  meilisearch:
    image: getmeili/meilisearch:v1.13.3
    container_name: karakeep-meilisearch
    restart: unless-stopped
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ${CONFIG_ROOT}/karakeep/meili_data:/meili_data
    networks:
      - internal

  chrome:
    image: gcr.io/zenika-hub/alpine-chrome:124
    restart: unless-stopped
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    networks:
      - internal

networks:
  traefik_public:
    external: true
  internal:
    driver: bridge
